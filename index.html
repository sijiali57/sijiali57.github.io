<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1671.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Menlo; color: #2b9543; -webkit-text-stroke: #2b9543}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Menlo; color: #286daf; -webkit-text-stroke: #286daf}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Menlo; color: #000000; -webkit-text-stroke: #000000}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Menlo; color: #505050; -webkit-text-stroke: #505050}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Menlo; color: #6154a1; -webkit-text-stroke: #6154a1}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Menlo; color: #000000; -webkit-text-stroke: #000000; min-height: 14.0px}
    span.s1 {font-kerning: none}
    span.s2 {font-kerning: none; color: #000000; -webkit-text-stroke: 0px #000000}
    span.s3 {font-kerning: none; color: #286daf; -webkit-text-stroke: 0px #286daf}
    span.s4 {font-kerning: none; color: #dd3f0e; -webkit-text-stroke: 0px #dd3f0e}
    span.s5 {font-kerning: none; color: #6154a1; -webkit-text-stroke: 0px #6154a1}
    span.s6 {font-kerning: none; color: #2b9543; -webkit-text-stroke: 0px #2b9543}
    span.s7 {font-kerning: none; color: #505050; -webkit-text-stroke: 0px #505050}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!DOCTYPE html&gt;</span></p>
<p class="p2"><span class="s1">&lt;html&gt;</span></p>
<p class="p2"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;head&gt;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;meta </span><span class="s4">charset</span><span class="s3">=</span><span class="s5">"utf-8"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;style&gt;</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span></span><span class="s1">/* CSS goes here. */</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">.subunit</span><span class="s1"> {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">fill</span><span class="s1">: none;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">stroke</span><span class="s1">: </span><span class="s6">#FFF</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">stroke-width</span><span class="s1">: </span><span class="s6">1px</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p2"><span class="s2"><span class="Apple-converted-space">            </span></span><span class="s1">text.subunit-label</span><span class="s2"> {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">font-family</span><span class="s1">: </span><span class="s5">"Helvetica Neue"</span><span class="s1">, Helvetica, Arial, sans-serif;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">font-size</span><span class="s1">: </span><span class="s6">14px</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">font-weight</span><span class="s1">: </span><span class="s6">300</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">text-anchor</span><span class="s1">: middle;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">fill</span><span class="s1">: </span><span class="s6">#000</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">.subunit-label</span><span class="s1"> {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">display</span><span class="s1">: none;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">.graticule</span><span class="s1"> {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">fill</span><span class="s1">: none;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">stroke</span><span class="s1">: </span><span class="s6">#aaa</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">stroke-opacity</span><span class="s1">: .</span><span class="s6">5</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">stroke-width</span><span class="s1">: .</span><span class="s6">5px</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/style&gt;</span></p>
<p class="p2"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;/head&gt;</span></p>
<p class="p2"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;body&gt;</span></p>
<p class="p5"><span class="s2"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;script </span><span class="s4">src</span><span class="s3">=</span><span class="s1">"//d3js.org/d3.v3.min.js"</span><span class="s3"> </span><span class="s4">charset</span><span class="s3">=</span><span class="s1">"utf-8"</span><span class="s3">&gt;&lt;/script&gt;</span></p>
<p class="p5"><span class="s2"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;script </span><span class="s4">src</span><span class="s3">=</span><span class="s1">"//d3js.org/topojson.v1.min.js"</span><span class="s3">&gt;&lt;/script&gt;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;script&gt;</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span></span><span class="s1">/* JavaScript goes here. */</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span></span><span class="s1">// globals used in graph</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">var</span><span class="s1"> mapdata = {};</span></p>
<p class="p5"><span class="s2"><span class="Apple-converted-space">            </span></span><span class="s3">var</span><span class="s2"> palette = [</span><span class="s1">'#009933'</span><span class="s2">,</span><span class="s1">'#669900'</span><span class="s2">,</span><span class="s1">'#99cc00'</span><span class="s2">,</span><span class="s1">'#cccc00'</span><span class="s2">,</span><span class="s1">'#c7dc09'</span><span class="s2">,</span><span class="s1">'#edf933'</span><span class="s2">,</span><span class="s1">'#ffcc00'</span><span class="s2">, </span><span class="s1">'#ff9933'</span><span class="s2">, </span><span class="s1">'#ff6600'</span><span class="s2">,</span><span class="s1">'#ff5050'</span><span class="s2">];</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">var</span><span class="s1"> width = </span><span class="s6">960</span><span class="s1">, height = </span><span class="s6">960</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">var</span><span class="s1"> minDocCount = </span><span class="s6">0</span><span class="s1">, quantiles = {};</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span></span><span class="s1">// projection definitions</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">var</span><span class="s1"> projection = d3.geo.mercator()</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.scale((width + </span><span class="s6">1</span><span class="s1">) / </span><span class="s6">2</span><span class="s1"> / Math.PI)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.translate([width/</span><span class="s6">2</span><span class="s1">, height/</span><span class="s6">2</span><span class="s1">])</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.precision(</span><span class="s6">.1</span><span class="s1">);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">var</span><span class="s1"> path = d3.geo.path().projection(projection);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">var</span><span class="s1"> graticule = d3.geo.graticule();</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span></span><span class="s1">// SVG related definitions</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">var</span><span class="s1"> svg = d3.select(</span><span class="s5">'body'</span><span class="s1">).append(</span><span class="s5">'svg'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr({</span><span class="s5">'width'</span><span class="s1">: width, </span><span class="s5">'height'</span><span class="s1">: height})</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.append(</span><span class="s5">'g'</span><span class="s1">);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">var</span><span class="s1"> filter = svg.append(</span><span class="s5">'defs'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.append(</span><span class="s5">'filter'</span><span class="s1">)</span></p>
<p class="p5"><span class="s2"><span class="Apple-converted-space">                </span>.attr({</span><span class="s1">'x'</span><span class="s2">:</span><span class="s6">0</span><span class="s2">, </span><span class="s1">'y'</span><span class="s2">:</span><span class="s6">0</span><span class="s2">, </span><span class="s1">'width'</span><span class="s2">:</span><span class="s6">1</span><span class="s2">, </span><span class="s1">'height'</span><span class="s2">:</span><span class="s6">1</span><span class="s2">, </span><span class="s1">'id'</span><span class="s2">:</span><span class="s1">'gray-background'</span><span class="s2">});</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>filter.append(</span><span class="s5">'feFlood'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'flood-color'</span><span class="s1">, </span><span class="s5">'#f2f2f2'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'result'</span><span class="s1">, </span><span class="s5">'COLOR'</span><span class="s1">);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>filter.append(</span><span class="s5">'feMorphology'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'operator'</span><span class="s1">, </span><span class="s5">'dilate'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'radius'</span><span class="s1">, </span><span class="s5">'.9'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'in'</span><span class="s1">, </span><span class="s5">'SourceAlpha'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'result'</span><span class="s1">, </span><span class="s5">'MORPHED'</span><span class="s1">);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>filter.append(</span><span class="s5">'feComposite'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'in'</span><span class="s1">, </span><span class="s5">'SourceGraphic'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'in2'</span><span class="s1">, </span><span class="s5">'MORPHED'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'result'</span><span class="s1">, </span><span class="s5">'COMP1'</span><span class="s1">);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>filter.append(</span><span class="s5">'feComposite'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'in'</span><span class="s1">, </span><span class="s5">'COMP1'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">'in2'</span><span class="s1">, </span><span class="s5">'COLOR'</span><span class="s1">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>svg.append(</span><span class="s5">"path"</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.datum(graticule)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">"class"</span><span class="s1">, </span><span class="s5">"graticule"</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>.attr(</span><span class="s5">"d"</span><span class="s1">, path);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>d3.json(</span><span class="s5">'mockelasticdata.json'</span><span class="s1">, </span><span class="s3">function</span><span class="s1">(error, mockdata) {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">if</span><span class="s1"> (error) </span><span class="s3">return</span><span class="s1"> console.error(error);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>console.log(</span><span class="s5">'mockdata'</span><span class="s1">,mockdata);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>mapdata = mockdata;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>draw(mockdata)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">function</span><span class="s1"> draw(data) {</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                </span></span><span class="s1">// var localstoreWorldData = localStorage.getItem('worldmapData');</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                </span></span><span class="s1">// if (localstoreWorldData &amp;&amp; localstoreWorldData.length) {</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                </span></span><span class="s1">// <span class="Apple-converted-space">    </span>localstoreWorldData = JSON.parse(localstoreWorldData);</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                </span></span><span class="s1">// <span class="Apple-converted-space">    </span>console.log('localstoreWorldData',localstoreWorldData);</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                </span></span><span class="s1">// <span class="Apple-converted-space">    </span>if (localstoreWorldData) {</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                </span></span><span class="s1">// <span class="Apple-converted-space">        </span>processWorldD(localstoreWorldData, data);</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                </span></span><span class="s1">// <span class="Apple-converted-space">        </span>//no need proceed further</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                </span></span><span class="s1">// <span class="Apple-converted-space">        </span>return;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s7">// <span class="Apple-converted-space">    </span>}</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s7">// }</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>d3.json(</span><span class="s5">'world.json'</span><span class="s1">, </span><span class="s3">function</span><span class="s1">(error, world) {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s3">if</span><span class="s1"> (error) </span><span class="s3">return</span><span class="s1"> console.error(error);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>console.log(</span><span class="s5">'world'</span><span class="s1">,world);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>processWorldD(world, data);</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                    </span></span><span class="s1">//localStorage.setItem('worldmapData', JSON.stringify(world));</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">function</span><span class="s1"> processWorldD(world, data) {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s3">for</span><span class="s1">(</span><span class="s3">var</span><span class="s1"> idx=</span><span class="s6">0</span><span class="s1">; idx &lt; data.aggregations.world_map.buckets.length; idx++) {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s3">var</span><span class="s1"> cCode = data.aggregations.world_map.buckets[idx].key.toUpperCase();</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s3">var</span><span class="s1"> doc_count = data.aggregations.world_map.buckets[idx].doc_count;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s3">for</span><span class="s1">(</span><span class="s3">var</span><span class="s1"> wdx=</span><span class="s6">0</span><span class="s1">; wdx &lt; world.objects.subunits.geometries.length; wdx++) {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s3">var</span><span class="s1"> cName = world.objects.subunits.geometries[wdx].id.toUpperCase();</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s3">if</span><span class="s1"> (cCode === cName) {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                                </span>world.objects.subunits.geometries[wdx].properties.doc_count = doc_count;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                            </span>}</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s3">var</span><span class="s1"> subunits = topojson.feature(world, world.objects.subunits);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>subunits.features = subunits.features.filter(</span><span class="s3">function</span><span class="s1">(d){ </span><span class="s3">return</span><span class="s1"> d.id !== </span><span class="s5">"ATA"</span><span class="s1">; });</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>console.log(</span><span class="s5">'subunits'</span><span class="s1">,subunits);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>minDocCount = d3.min(subunits.features, </span><span class="s3">function</span><span class="s1">(d){ </span><span class="s3">return</span><span class="s1"> d.properties.doc_count; });</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>console.log(</span><span class="s5">'minDocCount'</span><span class="s1">,minDocCount);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s3">var</span><span class="s1"> doc_counts = subunits.features.map(</span><span class="s3">function</span><span class="s1">(d){ </span><span class="s3">return</span><span class="s1"> d.properties.doc_count; });</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>doc_counts = doc_counts.filter(</span><span class="s3">function</span><span class="s1">(d){ </span><span class="s3">return</span><span class="s1"> d; }).sort(d3.ascending);</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                    </span></span><span class="s1">//console.log('doc_counts',doc_counts);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>quantiles[</span><span class="s5">'0.95'</span><span class="s1">] = d3.quantile(doc_counts, </span><span class="s5">'0.95'</span><span class="s1">);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s3">var</span><span class="s1"> countries = svg.selectAll(</span><span class="s5">'path.subunit'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.data(subunits.features).enter();</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>countries.insert(</span><span class="s5">'path'</span><span class="s1">, </span><span class="s5">'.graticule'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'class'</span><span class="s1">, </span><span class="s3">function</span><span class="s1">(d) { </span><span class="s3">return</span><span class="s1"> </span><span class="s5">'subunit ca'</span><span class="s1">+d.id; })</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.style(</span><span class="s5">'fill'</span><span class="s1">, heatColor)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'d'</span><span class="s1">, path)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.on(</span><span class="s5">'mouseover'</span><span class="s1">,mouseoverLegend).on(</span><span class="s5">'mouseout'</span><span class="s1">,mouseoutLegend)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.on(</span><span class="s5">'click'</span><span class="s1">, coutryclicked);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>countries.append(</span><span class="s5">'svg:text'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'class'</span><span class="s1">, </span><span class="s3">function</span><span class="s1">(d){ </span><span class="s3">return</span><span class="s1"> </span><span class="s5">'subunit-label la'</span><span class="s1">+d.id+d.properties.name.replace(</span><span class="s5">/[ \.#']+/g</span><span class="s1">,</span><span class="s5">''</span><span class="s1">); })</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                        </span></span><span class="s1">//.attr('transform', function(d) { return 'translate('+ path.centroid(d) +')'; })</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'transform'</span><span class="s1">, </span><span class="s3">function</span><span class="s1">(d) { </span><span class="s3">return</span><span class="s1"> </span><span class="s5">'translate('</span><span class="s1">+(width-(</span><span class="s6">5</span><span class="s1">*d.properties.name.length))+</span><span class="s5">','</span><span class="s1">+(</span><span class="s6">15</span><span class="s1">)+</span><span class="s5">')'</span><span class="s1">; })</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'dy'</span><span class="s1">, </span><span class="s5">'.35em'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'filter'</span><span class="s1">, </span><span class="s5">'url(#gray-background)'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.append(</span><span class="s5">'svg:tspan'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'x'</span><span class="s1">, </span><span class="s6">0</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'dy'</span><span class="s1">, </span><span class="s6">5</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.text(</span><span class="s3">function</span><span class="s1">(d) { </span><span class="s3">return</span><span class="s1"> d.properties.name; })</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.append(</span><span class="s5">'svg:tspan'</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'x'</span><span class="s1">, </span><span class="s6">0</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.attr(</span><span class="s5">'dy'</span><span class="s1">, </span><span class="s6">20</span><span class="s1">)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                        </span>.text(</span><span class="s3">function</span><span class="s1">(d) { </span><span class="s3">return</span><span class="s1"> d.properties.doc_count ? d.properties.doc_count : </span><span class="s5">''</span><span class="s1">; });</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">function</span><span class="s1"> mouseoverLegend(datum, index) {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>d3.selectAll(</span><span class="s5">'.subunit-label.la'</span><span class="s1">+datum.id+datum.properties.name.replace(</span><span class="s5">/[ \.#']+/g</span><span class="s1">,</span><span class="s5">''</span><span class="s1">))</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>.style(</span><span class="s5">'display'</span><span class="s1">, </span><span class="s5">'inline-block'</span><span class="s1">);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>d3.selectAll(</span><span class="s5">'.subunit.ca'</span><span class="s1">+datum.id)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>.style(</span><span class="s5">'fill'</span><span class="s1">, </span><span class="s5">'#cc6699'</span><span class="s1">);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">function</span><span class="s1"> mouseoutLegend(datum, index) {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>d3.selectAll(</span><span class="s5">'.subunit-label.la'</span><span class="s1">+datum.id+datum.properties.name.replace(</span><span class="s5">/[ \.#']+/g</span><span class="s1">,</span><span class="s5">''</span><span class="s1">))</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>.style(</span><span class="s5">'display'</span><span class="s1">, </span><span class="s5">'none'</span><span class="s1">);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>d3.selectAll(</span><span class="s5">'.subunit.ca'</span><span class="s1">+datum.id)</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                    </span>.style(</span><span class="s5">'fill'</span><span class="s1">, heatColor(datum));</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">function</span><span class="s1"> coutryclicked(datum, index) {</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                </span></span><span class="s1">//filter event for this country should be applied here</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span>console.log(</span><span class="s5">'coutryclicked datum'</span><span class="s1">, datum);</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">function</span><span class="s1"> heatColor(d) {</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">if</span><span class="s1"> (quantiles[</span><span class="s5">'0.95'</span><span class="s1">] === </span><span class="s6">0</span><span class="s1"> &amp;&amp; minDocCount === </span><span class="s6">0</span><span class="s1">) </span><span class="s3">return</span><span class="s1"> </span><span class="s5">'#F0F0F0'</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">if</span><span class="s1"> (!d.properties.doc_count) </span><span class="s3">return</span><span class="s1"> </span><span class="s5">'#F0F0F0'</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">if</span><span class="s1"> (d.properties.doc_count &gt; quantiles[</span><span class="s5">'0.95'</span><span class="s1">]) </span><span class="s3">return</span><span class="s1"> palette[(palette.length - </span><span class="s6">1</span><span class="s1">)];</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">if</span><span class="s1"> (quantiles[</span><span class="s5">'0.95'</span><span class="s1">] == minDocCount) </span><span class="s3">return</span><span class="s1"> palette[(palette.length</span><span class="s6">-1</span><span class="s1">)];</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">var</span><span class="s1"> diffDocCount = quantiles[</span><span class="s5">'0.95'</span><span class="s1">] - minDocCount;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">var</span><span class="s1"> paletteInterval = diffDocCount / palette.length;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">var</span><span class="s1"> diffDocCountDatum = quantiles[</span><span class="s5">'0.95'</span><span class="s1">] - d.properties.doc_count;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">var</span><span class="s1"> diffDatumDiffDoc = diffDocCount - diffDocCountDatum;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">var</span><span class="s1"> approxIdx = diffDatumDiffDoc / paletteInterval;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">if</span><span class="s1"> (!approxIdx || Math.floor(approxIdx) === </span><span class="s6">0</span><span class="s1">) approxIdx = </span><span class="s6">0</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">else</span><span class="s1"> approxIdx = Math.floor(approxIdx) - </span><span class="s6">1</span><span class="s1">;</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">return</span><span class="s1"> palette[approxIdx];</span></p>
<p class="p3"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p2"><span class="s2"><span class="Apple-converted-space">        </span></span><span class="s1">&lt;/script&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p2"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;/body&gt;</span></p>
<p class="p2"><span class="s1">&lt;/html&gt;</span></p>
</body>
</html>
